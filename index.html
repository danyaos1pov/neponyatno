<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ON1X VPN</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary-color: #2481cc;
            --bg-dark: #0d1117;
            --card-bg: #161b22;
            --text-color: #e6edf3;
            --chip-bg-active: #1e3a2b;
            --chip-bg-expired: #3a1e1e;
            --chip-bg-none: #2d2d2d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background: var(--bg-dark); color: var(--text-color); min-height: 100vh; padding-bottom: 50px; text-align: center; overflow-x: hidden; }
        a { text-decoration: none; color: inherit; }

        /* === СТРАНИЦЫ === */
        .page { position: absolute; top: 0; left: 50%; width: 100%; max-width: 600px; padding: 20px 15px; transform: translateX(-50%); display: none; opacity: 0; z-index: 10; }
        .page.active { display: block; opacity: 1; z-index: 15; }

        /* === ПРОФИЛЬ === */
        .user-profile { display: flex; align-items: center; justify-content: flex-start; margin: 20px auto; max-width: 500px; padding: 15px; gap: 12px; background: var(--card-bg); border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .user-greeting { font-size: 1.1em; font-weight: 600; color: var(--text-color); text-align: left; margin-bottom: 3px; }
        .user-id { font-size: 0.85em; color: #b0b8c2; text-align: left; }

        /* === ЗАГОЛОВОК === */
        h1 { font-size: 2.2em; margin: 10px 0 20px; color: var(--primary-color); }
        h1 span { color: var(--text-color); }

        /* === ГЛАВНЫЙ БЛОК === */
        .subscription-block {
            max-width: 500px;
            margin: 20px auto;
            background: var(--card-bg);
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .info-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; font-size: 1.05em;
        }
        .info-label { font-weight: 600; color: #b0b8c2; }
        .info-value { font-weight: 600; color: var(--text-color); }

        /* === СТАТУС ПОДПИСКИ — МЕНЬШЕ === */
        .status-chip {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 9px; border-radius: 14px;
            font-size: 0.75em; /* ← меньше */
            font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .status-active { background: var(--chip-bg-active); color: #28a745; border: 1px solid #28a745; }
        .status-expired { background: var(--chip-bg-expired); color: #dc3545; border: 1px solid #dc3545; }
        .status-none { background: var(--chip-bg-none); color: #b0b8c2; border: 1px solid #444; }

        /* === КЛЮЧ === */
        .key-input-container {
            position: relative; margin: 14px 0 0;
            background: rgba(255,255,255,0.04); border-radius: 12px; padding: 12px;
            display: flex; align-items: center;
        }
        #vpn-key-input {
            background: transparent; border: none; color: var(--text-color);
            font-family: monospace; font-size: 0.95em; width: 100%; padding-right: 45px;
            pointer-events: none; word-break: break-all; line-height: 1.4;
        }
        #copy-key-button {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            background: var(--primary-color); color: white; border: none;
            width: 34px; height: 34px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            font-size: 0.95em; transition: all 0.2s;
        }
        #copy-key-button:hover { background: #1d6fa5; transform: translateY(-50%) scale(1.1); }

        /* === КНОПКИ TELEGRAM === */
        .action-button-block {
            margin-top: 14px;
        }
        .tg-button {
            display: block; width: 100%; padding: 13px 0; background: var(--primary-color);
            color: white; font-weight: 500; font-size: 1.05em; text-align: center;
            border-radius: 8px; cursor: pointer; transition: background 0.2s;
        }
        .tg-button:hover, .tg-button:active { background: #1d6fa5; }

        /* === PULL TO REFRESH — С ПЛАШКОЙ "Обновляем" === */
        #pull-refresh {
            position: absolute; top: -60px; left: 0; width: 100%; height: 60px;
            display: flex; justify-content: center; align-items: center;
            background: rgba(36, 129, 204, 0.1);
            color: #2481cc; font-size: 0.95em; font-weight: 500;
            transition: top 0.3s ease;
            z-index: 100; backdrop-filter: blur(4px);
            border-bottom: 1px solid rgba(36, 129, 204, 0.3);
        }
        #pull-refresh i { margin-right: 8px; animation: spin 1s linear infinite; opacity: 0; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .app-version { margin-top: 30px; font-size: 0.8em; color: #6c757d; text-align: center; }
    </style>
</head>
<body>

    <!-- === PULL TO REFRESH === -->
    <div id="pull-refresh">
        <i class="fas fa-sync-alt"></i> Тяните для обновления
    </div>

    <!-- === ГЛАВНАЯ === -->
    <div id="home" class="page">
        <div class="user-profile">
            <img id="user-avatar" class="user-avatar" src="" alt="Аватар">
            <div>
                <div id="user-greeting" class="user-greeting">Добро пожаловать, </div>
                <div id="user-id" class="user-id"></div>
            </div>
        </div>

        <h1><span>ON1X</span> VPN</h1>

        <!-- === ГЛАВНЫЙ БЛОК === -->
        <div class="subscription-block">
            <div class="info-row">
                <span class="info-label">Тариф:</span>
                <span id="tariff-name" class="info-value">Загрузка...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Статус подписки:</span>
                <span id="status-display"></span>
            </div>

            <!-- Ключ -->
            <div class="key-input-container">
                <input type="text" id="vpn-key-input" value="Загрузка..." readonly>
                <button id="copy-key-button" title="Скопировать ключ">
                    <i class="fas fa-copy"></i>
                </button>
            </div>

            <!-- Кнопка -->
            <div id="action-button-block" class="action-button-block"></div>
        </div>

        <div class="app-version">Версия: 1.0.0</div>
    </div>

    <div id="buy" class="page"></div>
    <div id="renew" class="page"></div>

    <script>
        // === ЗАПРЕТ КОНТЕКСТА ===
        document.addEventListener('contextmenu', e => e.preventDefault());

        // === КОПИРОВАНИЕ ===
        function copyText(text) {
            navigator.clipboard.writeText(text);
            const btn = document.getElementById('copy-key-button');
            const icon = btn.querySelector('i');
            icon.classList.replace('fa-copy', 'fa-check');
            btn.style.background = '#28a745';
            setTimeout(() => {
                icon.classList.replace('fa-check', 'fa-copy');
                btn.style.background = 'var(--primary-color)';
            }, 1000);
        }

        document.getElementById('copy-key-button').onclick = () => {
            const key = document.getElementById('vpn-key-input').value;
            if (key && !key.includes('нет') && !key.includes('Загрузка')) {
                copyText(key);
            }
        };

        // === НАВИГАЦИЯ ===
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none';
            });
            const page = document.getElementById(id);
            page.style.display = 'block';
            setTimeout(() => page.classList.add('active'), 10);

            if (Telegram?.WebApp?.BackButton) {
                if (id === 'home') {
                    Telegram.WebApp.BackButton.hide();
                } else {
                    Telegram.WebApp.BackButton.show();
                    Telegram.WebApp.BackButton.onClick(() => showPage('home'));
                }
            }
        }

        // === API ===
        const API_URL = 'https://script.google.com/macros/s/AKfycbxSmUasXhD9sp6T0QUEgKq_on2rRhDDDtzT5aKGn8J-s73Wm-bLvryq0Q8XgzlBLObE/exec';

        // === ЗАГРУЗКА ДАННЫХ ===
        function loadUserData() {
            if (!Telegram?.WebApp?.initDataUnsafe?.user) {
                document.getElementById('vpn-key-input').value = 'Запустите в Telegram';
                return;
            }

            const u = Telegram.WebApp.initDataUnsafe.user;
            const userId = u.id;

            document.getElementById('user-avatar').src = u.photo_url || 'https://sun9-8.userapi.com/s/v1/ig2/YBkIITuiQ13e1vw3WhNGJekU_fMB3jXEeTjqLb-EAnydjnDmqCVu7sATDepkrUUo6UXWQ4x74BtgfBrgdhWUZZlN.jpg?quality=95&as=32x32,48x48,72x72,108x108,160x160,240x240,360x360,480x480,540x540,640x640&from=bu&cs=640x0';
            document.getElementById('user-greeting').textContent = `Добро пожаловать, ${u.first_name}${u.last_name ? ' ' + u.last_name : ''}`;
            document.getElementById('user-id').textContent = `ID: ${userId}`;

            const url = `${API_URL}?id=${userId}`;
            console.log('Запрос:', url);

            fetch(url)
                .then(r => r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
                .then(data => {
                    console.log('Ответ API:', data);
                    const keyInput = document.getElementById('vpn-key-input');
                    const tariffEl = document.getElementById('tariff-name');
                    const statusEl = document.getElementById('status-display');
                    const actionBlock = document.getElementById('action-button-block');
                    actionBlock.innerHTML = '';

                    if (data.not_found || !data.key_1) {
                        keyInput.value = 'У вас нет подписки';
                        keyInput.style.color = '#dc3545';
                        tariffEl.textContent = '—';
                        statusEl.innerHTML = `<span class="status-chip status-none">Нет</span>`;

                        const buyBtn = document.createElement('a');
                        buyBtn.className = 'tg-button';
                        buyBtn.onclick = () => showPage('buy');
                        buyBtn.textContent = 'Купить';
                        actionBlock.appendChild(buyBtn);
                        return;
                    }

                    keyInput.value = data.key_1;
                    tariffEl.textContent = data.tariff || 'Неизвестно';

                    let statusHtml = '';
                    if (data.key_status === 'active') {
                        statusHtml = `<span class="status-chip status-active">Активна</span>`;
                    } else if (data.key_status === 'expired') {
                        statusHtml = `<span class="status-chip status-expired">Истекла</span>`;
                    } else {
                        statusHtml = `<span class="status-chip status-none">Неизвестно</span>`;
                    }
                    statusEl.innerHTML = statusHtml;

                    const renewBtn = document.createElement('a');
                    renewBtn.className = 'tg-button';
                    renewBtn.onclick = () => showPage('renew');
                    renewBtn.textContent = 'Продлить';
                    actionBlock.appendChild(renewBtn);

                    if (data.key_2) {
                        const extra = document.createElement('div');
                        extra.innerHTML = `
                            <div class="key-input-container" style="margin-top: 12px; opacity: 0.9;">
                                <input type="text" value="${data.key_2}" readonly style="font-size: 0.9em;">
                                <button onclick="copyText('${data.key_2}')"><i class="fas fa-copy"></i></button>
                            </div>
                        `;
                        actionBlock.before(extra);
                    }
                })
                .catch(err => {
                    console.error('Ошибка:', err);
                    document.getElementById('vpn-key-input').value = 'Ошибка сети';
                });
        }

        // === PULL TO REFRESH — С ПЛАШКОЙ "Обновляем" ===
        let startY = 0;
        let pullDistance = 0;
        const pullThreshold = 100;
        const refreshEl = document.getElementById('pull-refresh');
        const icon = refreshEl.querySelector('i');

        document.addEventListener('touchstart', e => {
            if (window.scrollY === 0) {
                startY = e.touches[0].clientY;
                refreshEl.style.transition = 'none';
            }
        });

        document.addEventListener('touchmove', e => {
            if (startY && window.scrollY === 0) {
                const currentY = e.touches[0].clientY;
                pullDistance = currentY - startY;

                if (pullDistance > 0) {
                    e.preventDefault();
                    const progress = Math.min(pullDistance, 150);
                    refreshEl.style.top = (progress - 60) + 'px';

                    if (pullDistance > pullThreshold) {
                        refreshEl.innerHTML = '<i class="fas fa-sync-alt"></i> Отпустите для обновления';
                        icon.style.opacity = '1';
                        icon.style.animation = 'spin 1s linear infinite';
                    } else {
                        refreshEl.innerHTML = '<i class="fas fa-sync-alt"></i> Тяните для обновления';
                        icon.style.opacity = '0.6';
                        icon.style.animation = 'none';
                    }
                }
            }
        });

        document.addEventListener('touchend', () => {
            if (pullDistance > pullThreshold) {
                // Показываем "Обновляем"
                refreshEl.innerHTML = '<i class="fas fa-sync-alt"></i> Обновляем';
                icon.style.opacity = '1';
                icon.style.animation = 'spin 1s linear infinite';
                refreshEl.style.top = '0px';
                refreshEl.style.transition = 'top 0.3s ease';

                // Перезагружаем
                setTimeout(() => {
                    location.reload();
                }, 600);
            } else {
                // Плавно убираем
                refreshEl.style.top = '-60px';
                refreshEl.style.transition = 'top 0.3s ease';
            }
            startY = 0;
            pullDistance = 0;
        });

        // === ИНИЦИАЛИЗАЦИЯ ===
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('home').style.display = 'block';
            setTimeout(() => document.getElementById('home').classList.add('active'), 10);

            if (Telegram?.WebApp) {
                Telegram.WebApp.ready();
                if (Telegram.WebApp.disableVerticalSwipes) {
                    Telegram.WebApp.disableVerticalSwipes();
                }
            }

            loadUserData();
        });
    </script>
</body>
</html>
